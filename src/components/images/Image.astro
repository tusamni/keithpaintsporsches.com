---
import { cosmic } from "@/library/cosmic";

export interface Props {
    src: string;
    figureClass?: string;
    pictureClass?: string;
    showTitle?: boolean;
    rounded?: boolean;
    gallery?: boolean;
    lazy?: boolean;
}
const {
    src,
    figureClass,
    pictureClass,
    showTitle = true,
    rounded = true,
    gallery = true,
    lazy = true,
    ...attrs
} = Astro.props;

// config
const imageConfig = {
    imageSizes: [
        4000, 3000, 2000, 1800, 1400, 1300, 1200, 1100, 1000, 950, 900, 850,
        800, 750, 700, 600, 500, 400, 300, 200,
    ],
};

const imageName = src.replace("https://cdn.cosmicjs.com/", "");

const imageMetadata = await cosmic.media
    .findOne({ name: imageName })
    .props(
        "name, original_name, folder, url, imgix_url, width, height, alt_text, metadata",
    );

// loop through all the necessary image widths
const imageOptimized = [];
for (let size of imageConfig.imageSizes) {
    imageOptimized.push(
        `${imageMetadata.media.imgix_url}?w=${size}&auto=format ${size}w`,
    );
}

const imageSrcSet = imageOptimized.join(", ");
---

<figure
    class:list={[
        "group overflow-hidden @container",
        gallery && "gallery hover:cursor-pointer",
        rounded && "rounded",
        showTitle && "relative",
        figureClass,
    ]}
    style={`--width: ${imageMetadata.media.width}; --height: ${imageMetadata.media.height};`}
    data-src={`${imageMetadata.media.imgix_url}?auto=format,compress`}
    data-srcset={imageSrcSet}
    data-thumb={`${imageMetadata.media.imgix_url}?w=200&auto=format,compress`}
    data-lg-size={`${imageMetadata.media.width}-${imageMetadata.media.height}`}
    data-sizes="200vw"
    data-sub-html={`<div class="text-2xl tracking-tight uppercase font-bold">${imageMetadata.media.alt_text}</div><div>${imageMetadata.media.metadata.caption}</div>`}
>
    {
        imageMetadata ? (
            <img
                srcset={imageSrcSet}
                src={`${imageMetadata.media.imgix_url}?auto=format,compress`}
                alt={imageMetadata.media.alt}
                width={imageMetadata.media.width}
                height={imageMetadata.media.height}
                {...attrs}
                loading={lazy ? "lazy" : "eager"}
            />
        ) : (
            <img
                src={`${imageMetadata.media.imgix_url}?auto=format,compress`}
                srcset={imageSrcSet}
                loading={lazy ? "lazy" : "eager"}
                {...attrs}
            />
        )
    }

    <!-- {
        imageMetadata && showTitle && (
            <figcaption class="absolute bottom-0 right-0">
                <div class="w-fit flex flex-col text-right antialiased bg-black rounded-tl py-2 sm:py-4 px-3 sm:px-6">
                    <div class="font-semibold tracking-wide uppercase text-sm lg:text-base line-clamp-1">
                        {imageMetadata.media.alt_text}
                    </div>

                    <div class="text-neutral-300 text-xs md:text-sm line-clamp-1">
                        {imageMetadata.media.metadata.caption}
                    </div>
                </div>
            </figcaption>
        )
    } -->
</figure>
